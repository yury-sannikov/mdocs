extends ../layouts/layout.pug

//- http://cwbuecheler.com/web/tutorials/2014/restful-web-app-node-express-mongodb/

block head
  title #{application} &middot; Providers

block content
  .container
    .row
      //- PROVIDERS INFO
      .col-md-12
        .page-header
          h2
            i.fa.fa-user
            | &nbsp;Providers
        a.linknewprovider.btn.btn-success.pull-center(href="#") New Provider
        //- /PROVIDERS INFO

        //- WRAPPER
        #wrapper

          //- USER LIST
          #userList
            table.table.table-striped
              thead
                th Full name
                th Email
                th Phone
                th Actions
              tbody
                each provider, i in providers
                  tr
                    td
                      span #{provider.name}
                    td
                      strong #{provider.email}
                    td
                      span #{formatPhone(provider.phone)}
                    td
                      a.btn.btn-info.btn-xs(href='provider/'+provider.id) View
                      | &nbsp;
                      a.linkedit.btn.btn-primary.btn-xs(href="#", data-providerId=provider.id) Edit&nbsp;
                      | &nbsp;
                      a.linkdeleteprovider.btn.btn-danger.btn-xs(href="#", data-providerId=provider.id) Delete&nbsp;
          - if (providers.length === 0)
            span No providers found in a database.
          //- /USER LIST

        //- /WRAPPER


  #deleteModal.modal.fade(tabindex='-1', role='dialog', aria-labelledby='deleteModalLabel', aria-hidden='true')
      .modal-dialog.modal-sm
        .modal-content
          .modal-header
            button.close(type='button', data-dismiss='modal', aria-hidden='true') ×
            h4#deleteModalLabel.modal-title Delete confirmation
          .modal-body
            h4 Are you sure?
            form#deleteform(action='delete-provider', method='POST')
              input.form-control(type='hidden', name='_csrf', value=_csrf)
              input#deleteformid.form-control(type='hidden', name='id')
          .modal-footer
            button.btn.btn-default(type='button', data-dismiss='modal') No
            button#deleteModalConfirm.btn.btn-primary(type='button') Yes!


  #providerModal.modal.fade(tabindex='-1', role='dialog', aria-labelledby='myModalLabel', aria-hidden='true')
      .modal-dialog.modal-md
        .modal-content
          .modal-header
            button.close(type='button', data-dismiss='modal', aria-hidden='true') ×
            h4#myModalLabel.modal-title New Provider
          .modal-body
            .row
              .col-sm-12
                h4 Provider Details
                form#providerform(action='new-provider', method='POST')
                  input.form-control(type='hidden', name='_csrf', value=_csrf)
                  .form-group
                    label.sr-only(for='name') Name
                    .input-group
                      input.form-control(type='text', name='name', id='name', placeholder='Full name')
                  .form-group
                    label.sr-only(for='email') Email
                    input.form-control(type='email', name='email', id='email', placeholder='Email')
                    #hint
                  .form-group
                    label.sr-only(for='phoneMobile') Phone
                    input.form-control(type='tel', name='phoneMobile', id='phoneMobile', placeholder='Phone number e.g. (703) 123-4567', pattern='/(?:(?:\+?1\s*(?:[.-]\s*)?)?(?:(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]‌​)\s*)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)([2-9]1[02-9]‌​|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})/', title='Phone Number: +1 (999) 999-9999')
                  h4 Review Site IDs
                  .form-group
                    label.sr-only(for='yelp') Yelp
                    label.sr-only(for='defaultReviewSite')
                    .input-group
                      input.form-control-static.defaultSite(style="width: 70%", type='text', name='yelp', id='yelp', placeholder='Yelp ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="yelpDefaultRadio", value='yelp', style="margin-left: 10px;", checked="checked")
                  .form-group
                    label.sr-only(for='google') Google
                    .input-group
                      input.form-control-static.defaultSite(style="width: 70%", type='text', name='google', id='google', placeholder='Google ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="googleDefaultRadio", value='google', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='healthgrades') HealthGrades.com
                    .input-group
                      input.form-control-static.defaultSite(style="width: 70%", type='text', name='healthgrades', id='healthgrades', placeholder='HealthGrades.com ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="healthgradesDefaultRadio", value='healthgrades', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='vitals') Vitals.com
                    .input-group
                      input.form-control-static.defaultSite(style="width: 70%", type='text', name='vitals', id='vitals', placeholder='Vitals.com ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="vitalsDefaultRadio", value='vitals', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='ratemds') RateMDs.com
                    .input-group
                      input.form-control-static.defaultSite(style="width: 70%", type='text', name='ratemds', id='ratemds', placeholder='RateMDs.com ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="ratemdsDefaultRadio", value='ratemds', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='yellowpages') Yellow Pages
                    .input-group
                      input.form-control-static.defaultSite(style="width: 70%", type='text', name='yellowpages', id='yellowpages', placeholder='Yellow Pages ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="yellowpagesDefaultRadio", value='yellowpages', style="margin-left: 10px;")

          .modal-footer
            button.btn.btn-default(type='button', data-dismiss='modal') Cancel
            button#sendproviderbutton.btn.btn-primary(type='button') Save


  #editProviderModal.modal.fade(tabindex='-1', role='dialog', aria-labelledby='editModalLabel', aria-hidden='true')
      .modal-dialog.modal-md
        .modal-content
          .modal-header
            button.close(type='button', data-dismiss='modal', aria-hidden='true') ×
            h4#editLabel.modal-title Edit Provider
          .modal-body
            .row
              .col-sm-12
                h4 Provider Details
                form#editproviderform(action='update-provider', method='POST')
                  input.form-control(type='hidden', name='editID', id='editID')
                  input.form-control(type='hidden', name='_csrf', value=_csrf)
                  .form-group
                    label.sr-only(for='name') Name
                    .input-group
                      input.form-control(type='text', name='name', id='editName', placeholder='Provider name')
                  .form-group
                    label.sr-only(for='email') Email
                    input.form-control(type='email', name='email', id='editEmail', placeholder='Email')
                    #hint
                  .form-group
                    label.sr-only(for='phoneMobile') Phone
                    input.form-control(type='tel', name='phoneMobile', id='editPhoneMobile', placeholder='Phone number e.g. (703) 123-4567', pattern='/(?:(?:\+?1\s*(?:[.-]\s*)?)?(?:(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]‌​)\s*)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)([2-9]1[02-9]‌​|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})/', title='Phone Number: +1 (999) 999-9999')
                  h4 Review Site IDs
                  .form-group
                    label.sr-only(for='yelp') Yelp
                    .input-group
                      input.form-control-static.editDefaultSite(style="width: 70%", type='text', name='yelp', id='editYelp', placeholder='Yelp ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="editYelpDefaultRadio", value='yelp', style="margin-left: 10px;", checked="checked")
                  .form-group
                    label.sr-only(for='google') Google
                    .input-group
                      input.form-control-static.editDefaultSite(style="width: 70%", type='text', name='google', id='editGoogle', placeholder='Google ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="editGoogleDefaultRadio", value='google', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='healthgrades') HealthGrades.com
                    .input-group
                      input.form-control-static.editDefaultSite(style="width: 70%", type='text', name='healthgrades', id='editHealthgrades', placeholder='HealthGrades.com ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="editHealthgradesDefaultRadio", value='healthgrades', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='vitals') Vitals.com
                    .input-group
                      input.form-control-static.editDefaultSite(style="width: 70%", type='text', name='vitals', id='editVitals', placeholder='Vitals.com ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="editVitalsDefaultRadio", value='vitals', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='ratemds') RateMDs.com
                    .input-group
                      input.form-control-static.editDefaultSite(style="width: 70%", type='text', name='ratemds', id='editRatemds', placeholder='RateMDs.com ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="editRatemdsDefaultRadio", value='ratemds', style="margin-left: 10px;")
                  .form-group
                    label.sr-only(for='yellowpages') Yellow Pages
                    .input-group
                      input.form-control-static.editDefaultSite(style="width: 70%", type='text', name='yellowpages', id='editYellowpages', placeholder='Yellow Pages ID')
                      h5(style="float: right; font-weight: bold;") Set Default
                        input(type="radio", name="defaultReviewSite", id="editYellowpagesDefaultRadio", value='yellowpages', style="margin-left: 10px;")

          .modal-footer
            button.btn.btn-default(type='button', data-dismiss='modal') Cancel
            button#sendeditproviderbutton.btn.btn-primary(type='button') Save

  //- script(src='lib/moment/min/moment.min.js')
  //- script(src='lib/bootstrap/js/modal.js')
block scripts
  script.
    // Userlist data array for filling in info box
    var userListData = [];
    // List of providers passed in
    const providers = !{JSON.stringify(providers)};

    // DOM Ready =============================================================
    (function(init) {
      init(window.jQuery, window, document);
    }(function($, window, document) {

      $(function() {

        //- Async Load Bootstrap Modal
        $.ajax({
          type: 'GET',
          url: '/app/lib/bootstrap/js/modal.js',
          dataType: 'script',
          cache: true
        });

        // Add this method to validate at least one field from a group
        $.validator.addMethod("require_from_group", function (value, element, options) {
          var numberRequired = options[0];
          var selector = options[1];
          var fields = $(selector, element.form);
          var filled_fields = fields.filter(function () {
              return $(this).val() !== '';
          });
          var empty_fields = fields.not(filled_fields);
          // we will mark only first empty field as invalid
          if (filled_fields.length < numberRequired && empty_fields[0] == element) {
              return false;
          }
          return true;
        }, $.validator.format("Please provide at least one ID."));


        // Delete provider link click
        $('#userList').on('click', '.linkdeleteprovider', deleteProvider);

        // New provider link click
        $('.linknewprovider').on('click', newProvider);

        // Edit provider link click
        $('.linkedit').on('click', editProvider);

      });
    }));

    // Functions =============================================================


    // Delete Provider
    function deleteProvider(event) {

      // Prevent Link from Firing
      event.preventDefault();

      // Pop up a confirmation dialog
      // Convoluted because we have to
      // pass the user's id through
      function showmodal(id) {
        // show modal
        $('#deleteModal').modal({keyboard:true,backdrop:'static'});
        // if "yes" clicked
        $('#deleteModalConfirm').one('click', function () {
          // close the modal
          $('#deleteformid').val(id);
          $('#deleteform').submit();
          $('#deleteModal').modal('hide');
        });
      }

      // call modal function with the user's account id
      showmodal($(this).attr('data-providerId'));

    };


    // New Provider
    function newProvider(event) {

      // Prevent Link from Firing
      event.preventDefault();

      // Pop up a confirmation dialog
      // Convoluted because we have to
      // pass the user's id through
      function showmodal(id) {
        // show modal
        $('#myModalLabel').text('New Provider')
        $('#providerModal').modal({keyboard:true,backdrop:'static'});
        $("#providerform").validate({
          groups: {
            names: "yelp google healthgrades vitals ratemds yellowpages"
          },
          rules: {
            name: "required",
            email: {
              required: true,
              email: true
            },
            phoneMobile: {
              required: true
            },
            defaultReviewSite: {
              required: true
            },
            yelp: {
              require_from_group: [1, ".defaultSite"]
            },
            google: {
              require_from_group: [1, ".defaultSite"]
            },
            healthgrades: {
              require_from_group: [1, ".defaultSite"]
            },
            vitals: {
              require_from_group: [1, ".defaultSite"]
            },
            ratemds: {
              require_from_group: [1, ".defaultSite"]
            },
            yellowpages: {
              require_from_group: [1, ".defaultSite"]
            }
          },
          messages: {
            name: "Please specify the name of the location",
            address: {
              required: "We need the location's address"
            },
            email: {
              required: "We need an email address to contact",
              email: "The email address must be in the format of name@domain.com"
            },
            phoneMobile: {
              required: "We need a phone to contact"
            },
            defaultReviewSite: {
              required: "We need a default site"
            }
          },
          errorPlacement: function(error, element) {
            if(element.attr("type") === 'radio') {
              error.insertAfter(element.parent().parent())
            }
            else {
              error.insertAfter(element);
            }
          },
          submitHandler: function(form) {
            form.submit();
          },
          invalidHandler: function(event, validator) {
            console.log(event);
            console.log(validator);
          }
        });
        // if "yes" clicked
        $('#sendproviderbutton').one('click', function () {
            $('#providerform').submit();
        });
      }

      // call modal function with the user's account id
      showmodal($(this).attr('data-providerId'));

    };


    // Edit Provider
    function editProvider(event) {

      // Prevent Link from Firing
      event.preventDefault();

      // Pop up a confirmation dialog
      // Convoluted because we have to
      // pass the user's id through
      function showmodal(id) {
        // Populate attributes
        const user = providers.filter(function(pr) {
          return pr.id === id;
        })[0];

        $('#editID').val(user.id);
        $('#editName').val(user.name);
        $('#editEmail').val(user.email);
        $('#editPhoneMobile').val(user.phone);
        $('#editYelp').val(user.review_sites.yelp);
        $('#editGoogle').val(user.review_sites.google);
        $('#editHealthgrades').val(user.review_sites.healthgrades);
        $('#editVitals').val(user.review_sites.vitals);
        $('#editRatemds').val(user.review_sites.ratemds);
        $('#editYellowpages').val(user.review_sites.yellowpages);

        switch(user.default_review_site) {
          case 'yelp':
            $('#editYelpDefaultRadio').attr('checked', 'checked');
            break;
          case 'google':
            $('#editGoogleDefaultRadio').attr('checked', 'checked');
            break;
          case 'healthgrades':
            $('#editHealthgradesDefaultRadio').attr('checked', 'checked');
            break;
          case 'vitals':
            $('#editVitalsDefaultRadio').attr('checked', 'checked');
            break;
          case 'ratemds':
            $('#editRatemdsDefaultRadio').attr('checked', 'checked');
            break;
          default:
            $('#editYellowpagesDefaultRadio').attr('checked', 'checked');
            break;
        }

        // show modal
        $('#editProviderModal').modal({keyboard:true,backdrop:'static'});
        $("#editproviderform").validate({
          groups: {
            names: "editYelp editGoogle editHealthgrades editVitals editRatemds editYellowpages"
          },
          rules: {
            name: "required",
            email: {
              required: true,
              email: true
            },
            phoneMobile: {
              required: true
            },
            defaultReviewSite: {
              required: true
            },
            yelp: {
              require_from_group: [1, ".editDefaultSite"]
            },
            google: {
              require_from_group: [1, ".editDefaultSite"]
            },
            healthgrades: {
              require_from_group: [1, ".editDefaultSite"]
            },
            vitals: {
              require_from_group: [1, ".editDefaultSite"]
            },
            ratemds: {
              require_from_group: [1, ".editDefaultSite"]
            },
            yellowpages: {
              require_from_group: [1, ".editDefaultSite"]
            }
          },
          messages: {
            name: "Please specify the name of the location",
            address: {
              required: "We need the location's address"
            },
            email: {
              required: "We need an email address to contact",
              email: "The email address must be in the format of name@domain.com"
            },
            phoneMobile: {
              required: "We need a phone to contact"
            },
            defaultReviewSite: {
              required: "We need a default site"
            }
          },
          errorPlacement: function(error, element) {
            if(element.attr("type") === 'radio') {
              error.insertAfter(element.parent().parent())
            }
            else {
              error.insertAfter(element);
            }
          },
          submitHandler: function(form) {
            form.submit();
          },
          invalidHandler: function(event, validator) {
            console.log(event);
            console.log(validator);
          }
        });
        // if "yes" clicked
        $('#sendeditproviderbutton').one('click', function () {
            $('#editproviderform').submit();
        });
      }

      // call modal function with the user's account id
      showmodal($(this).attr('data-providerId'));

    };
